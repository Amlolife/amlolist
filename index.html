<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <title>Amlo List - Perencana Acara</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/idb-keyval@6/dist/umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #dfff6e;
            --background: #f8f8f8;
            --surface: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #8e8e8e;
            --border-color: #f0f0f0;
            --nav-bg: #1a1a1a;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease-out; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .modal-enter-active { transition: all 0.3s cubic-bezier(0.52, 0.02, 0.19, 1.02); }
        .modal-leave-active { transition: all 0.3s cubic-bezier(0.52, 0.02, 0.19, 1.02); }
        .modal-enter-from, .modal-leave-to { transform: scale(0.95); opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: scale(0.95); }
    </style>
</head>
<body class="text-[var(--text-main)] min-h-screen">
    <div id="app" class="pb-32">
        </div>
    
    <script>
        const { createApp } = Vue;
        const { jsPDF } = window.jspdf;
        const firebaseConfig = { apiKey: "AIzaSyB1bkUfIggcgcgTHGPGyY8zOaCgnR7wtFU", authDomain: "amlolist.firebaseapp.com", projectId: "amlolist", storageBucket: "amlolist.appspot.com", messagingSenderId: "550013427934", appId: "1:550013427934:web:86f32dfcbeb49de1b1e24f", measurementId: "G-TKK5Q8VL3M" };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const App = {
            data() {
                // ... (Data Anda tetap sama)
            },
            created() {
                this.resetAllModals();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.isLoggedIn = true;
                        this.user = user;
                        this.loadAppData();
                    } else {
                        this.isLoggedIn = false;
                        this.user = null;
                        this.isLoading = false;
                        this.appReady = false;
                    }
                });

                // --- FIX: Tambahkan event listener untuk tombol back ---
                window.addEventListener('popstate', this.handleBackButton);
            },
            beforeUnmount() {
                // --- FIX: Hapus event listener saat aplikasi ditutup ---
                window.removeEventListener('popstate', this.handleBackButton);
            },
            computed: {
                // ... (Computed properties Anda tetap sama)
            },
            methods: {
                // ... (Metode lain yang sudah ada) ...

                // --- FIX: Metode baru untuk menangani tombol back ---
                handleBackButton(event) {
                    // Prioritas 1: Tutup modal jika ada yang terbuka
                    if (this.photoToPreview) { this.closePhotoPreview(); return; }
                    if (this.showShotModal) { this.closeShotModal(); return; }
                    if (this.showEditModal) { this.closeEditModal(); return; }
                    if (this.showTimelineModal) { this.closeTimelineModal(); return; }
                    if (this.showForgotPasswordModal) { this.closeForgotPasswordModal(); return; }
                    if (this.showChangePasswordModal) { this.closeChangePasswordModal(); return; }

                    // Prioritas 2: Kembali ke Beranda jika tidak di Beranda
                    if (this.currentView !== 'beranda') {
                        this.currentView = 'beranda';
                        return;
                    }
                    
                    // Prioritas 3: Jika sudah di beranda, biarkan default (keluar aplikasi)
                    // Tidak perlu melakukan apa-apa, biarkan browser menangani
                },

                // --- FIX: Modifikasi metode navigasi untuk menambah history ---
                setView(view, pushState = true) {
                    if (this.currentView === view) return; // Jangan lakukan apa-apa jika view sama
                    this.currentView = view;
                    if (pushState) {
                        history.pushState({ view: view }, '', `#${view}`);
                    }
                },
                
                async loadAppData() {
                    this.appReady = false;
                    this.isLoading = true;
                    // ... (sisa kode loadAppData)
                    
                    // --- FIX: Set state awal tanpa menambah history ---
                    history.replaceState({ view: 'beranda' }, '', '#beranda');

                    this.isLoading = false;
                    this.appReady = true;
                },

                // --- FIX: Modifikasi semua metode open/close modal ---
                openPhotoPreview(url) {
                    this.photoToPreview = url;
                    history.pushState({ modal: 'photoPreview' }, '', '#preview');
                },
                closePhotoPreview(goBack = true) {
                    this.photoToPreview = null;
                    if (goBack) history.back();
                },
                openShotModal() {
                    if (this.activeWedding) {
                        this.newShot = { title: '', description: '' };
                        this.showShotModal = true;
                        history.pushState({ modal: 'shotModal' }, '', '#add-shot');
                    }
                },
                closeShotModal(goBack = true) {
                    this.showShotModal = false;
                    if (goBack) history.back();
                },
                openEditModal(wedding) {
                    this.weddingToEdit = JSON.parse(JSON.stringify(wedding));
                    this.showEditModal = true;
                    history.pushState({ modal: 'editModal' }, '', '#edit');
                },
                closeEditModal(goBack = true) {
                    this.showEditModal = false;
                    this.weddingToEdit = null;
                    if (goBack) history.back();
                },
                openTimelineModal() {
                    if (this.activeWedding) {
                        this.newTimelineItem = { title: '', time: '', notes: '' };
                        this.showTimelineModal = true;
                        history.pushState({ modal: 'timelineModal' }, '', '#add-timeline');
                    }
                },
                closeTimelineModal(goBack = true) {
                    this.showTimelineModal = false;
                    if (goBack) history.back();
                },
                openForgotPasswordModal() {
                    this.forgotPassword = { email: '', error: '', success: '' };
                    this.showForgotPasswordModal = true;
                    history.pushState({ modal: 'forgotPassword' }, '', '#forgot-password');
                },
                closeForgotPasswordModal(goBack = true) {
                    this.showForgotPasswordModal = false;
                    if (goBack) history.back();
                },
                openChangePasswordModal() {
                    this.changePassword = { newPassword: '', error: '', success: '' };
                    this.showChangePasswordModal = true;
                    history.pushState({ modal: 'changePassword' }, '', '#change-password');
                },
                closeChangePasswordModal(goBack = true) {
                    this.showChangePasswordModal = false;
                    if (goBack) history.back();
                },

                // Tambahkan ini ke metode logout Anda
                logout() {
                    auth.signOut();
                    this.resetAllModals();
                    // Tidak perlu `history.back()` di sini, karena onAuthStateChanged akan handle
                },
            }
        };
        // ... (createApp(App).mount('#app');)
    </script>
</body>
</html>
